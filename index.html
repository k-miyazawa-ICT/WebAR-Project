<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>AR.js Hiro Marker Sample</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@1.7.2/aframe/build/aframe-ar.min.js"></script>
    <script>
        AFRAME.registerComponent("track-marker", {
            init: function () {
                let marker = this.el;
                let model = document.querySelector("#myModel");
                let scene = document.querySelector("a-scene").object3D;

                let lastPosition = new THREE.Vector3();
                let lastQuaternion = new THREE.Quaternion();
                let modelDetached = false;

                marker.addEventListener("markerFound", function () {
                    console.log("✅ マーカー検出！位置を保存 & 半透明化");

                    // ワールド座標に変換
                    let worldPos = new THREE.Vector3();
                    let worldQuat = new THREE.Quaternion();
                    marker.object3D.getWorldPosition(worldPos);
                    marker.object3D.getWorldQuaternion(worldQuat);

                    lastPosition.copy(worldPos);
                    lastQuaternion.copy(worldQuat);
                    model.object3D.position.copy(lastPosition);
                    model.object3D.quaternion.copy(lastQuaternion);
                    model.setAttribute("visible", "true");

                    // 半透明化処理
                    setTimeout(() => {
                        let obj = model.getObject3D("mesh");
                        if (obj) {
                            obj.traverse((node) => {
                                if (node.isMesh) {
                                    node.material.transparent = true;
                                    node.material.opacity = 0.7;
                                    node.material.blending = THREE.NormalBlending;
                                    node.material.depthWrite = false;
                                    node.material.needsUpdate = true;
                                    console.log("✅ 半透明が適用されました！");
                                }
                            });
                        } else {
                            console.error("❌ obj が null になっています！（スマホの可能性あり）");
                        }
                    }, 100);
                    modelDetached = false;
                });

                marker.addEventListener("markerLost", function () {
                    if (!modelDetached) {
                        console.log("✅ マーカーが見えなくなったけど、モデルをワールド空間に固定");

                        scene.add(model.object3D);
                        model.object3D.position.copy(lastPosition);
                        model.object3D.quaternion.copy(lastQuaternion);
                        model.object3D.scale.set(8.6, 8.6, 8.6); 

                        setTimeout(() => {
                            model.setAttribute("visible", "true");
                        }, 200);

                        modelDetached = true;
                    }
                });
            }
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; detectionMode: mono; debugUIEnabled: false;">
        <a-marker preset="hiro" smooth="true" smoothCount="5" track-marker>
            <a-entity id="myModel" gltf-model="https://k-miyazawa-ICT.github.io/WebAR-Project/model.glb" 
                      scale="8.6 8.6 8.6" 
                      rotation="90 0 0" 
                      position="0.7 -0.66 0"
                      visible="false">
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>
