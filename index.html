<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>AR.js Hiro Marker Sample</title>

    <!-- A-Frame を先に読み込む -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

    <!-- AR.js を後に読み込む -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (typeof AFRAME === "undefined") {
                console.error("❌ AFRAME がロードされていません！");
                return;
            }

            console.log("✅ AFRAME が正しくロードされました！");

            let lastPosition = new THREE.Vector3();  
            let lastRotation = new THREE.Quaternion();
            let modelDetached = false;

            AFRAME.registerComponent('track-marker', {
                init: function () {
                    let marker = this.el;
                    let model = document.querySelector("#myModel").object3D;
                    let scene = document.querySelector("a-scene").object3D;

                    marker.addEventListener("markerFound", function () {
                        console.log("✅ マーカー検出！位置を保存 & 半透明化");

                        // ワールド座標・回転を取得
                        marker.object3D.getWorldPosition(lastPosition);
                        marker.object3D.getWorldQuaternion(lastRotation);

                        model.position.copy(lastPosition);
                        model.quaternion.copy(lastRotation);
                        model.visible = true;
                        modelDetached = false;

                        // 半透明化処理
                        setTimeout(() => {
                            model.traverse((node) => {
                                if (node.isMesh) {
                                    node.material.transparent = true;
                                    node.material.opacity = 0.7;
                                    node.material.alphaMode = "BLEND";
                                    node.material.blending = THREE.NormalBlending;
                                    node.material.depthWrite = false;
                                    node.material.needsUpdate = true;
                                    console.log("✅ 半透明が適用されました！");
                                }
                            });
                        }, 100);
                    });

                    marker.addEventListener("markerLost", function () {
                        if (!modelDetached) {
                            console.log("✅ マーカーが見えなくなったけど、モデルをワールド空間に固定");

                            // モデルをシーンの直下に移動（カメラの影響を受けない）
                            scene.add(model);

                            // ワールド座標を適用
                            model.position.copy(lastPosition);
                            model.quaternion.copy(lastRotation);
                            model.scale.set(8.6, 8.6, 8.6); // スケールを適用
                            
                            model.visible = true;
                            modelDetached = true;
                        }
                    });
                }
            });
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; detectionMode: mono; debugUIEnabled: false;">
        <!-- Hiroマーカーが見えたときに表示するモデル -->
        <a-marker preset="hiro" smooth="true" smoothCount="5" track-marker>
            <a-entity id="myModel" gltf-model="https://k-miyazawa-ICT.github.io/WebAR-Project/model.glb" 
                      scale="8.6 8.6 8.6" 
                      rotation="90 0 0" 
                      position="0.7 -0.66 0"
                      visible="false">
            </a-entity>
        </a-marker>
        <!-- カメラ -->
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>
