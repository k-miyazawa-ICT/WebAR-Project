<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>AR.js Hiro Marker Sample</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar.min.js"></script>

    <script>
        let lastPosition = null;  // 最後のワールド座標を記録
        let lastRotation = null;  // 最後の回転を記録
        let modelDetached = false; // モデルがワールド空間に移動したか

        document.addEventListener("DOMContentLoaded", function () {
            let scene = new THREE.Scene();
            let camera = new THREE.Camera();
            scene.add(camera);

            let renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            let arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
            arToolkitSource.init(() => {
                setTimeout(() => {
                    arToolkitSource.onResizeElement();
                    arToolkitSource.copyElementSizeTo(renderer.domElement);
                }, 1000);
            });

            let arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: "https://rawgit.com/jeromeetienne/ar.js/master/data/camera_para.dat",
                detectionMode: "mono"
            });
            arToolkitContext.init(() => {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });

            let markerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
                type: "pattern",
                patternUrl: "https://rawgit.com/jeromeetienne/ar.js/master/data/patt.hiro",
                changeMatrixMode: "modelViewMatrix"
            });

            let loader = new THREE.GLTFLoader();
            loader.load("https://k-miyazawa-ICT.github.io/WebAR-Project/model.glb", function (gltf) {
                let model = gltf.scene;
                model.scale.set(8.6, 8.6, 8.6);
                model.visible = false;
                scene.add(model);

                markerControls.addEventListener("markerFound", function () {
                    console.log("✅ マーカー検出！位置を保存 & 半透明化");
                    let worldPos = new THREE.Vector3();
                    let worldRot = new THREE.Quaternion();
                    camera.getWorldPosition(worldPos);
                    camera.getWorldQuaternion(worldRot);
                    lastPosition = worldPos.clone();
                    lastRotation = worldRot.clone();
                    model.position.copy(lastPosition);
                    model.quaternion.copy(lastRotation);
                    model.visible = true;
                });

                markerControls.addEventListener("markerLost", function () {
                    if (lastPosition && !modelDetached) {
                        console.log("✅ マーカーが見えなくなったけど、モデルをワールド空間に固定");
                        model.position.copy(lastPosition);
                        model.quaternion.copy(lastRotation);
                        model.visible = true;
                        modelDetached = true;
                    }
                });
            });

            function animate() {
                requestAnimationFrame(animate);
                if (arToolkitSource.ready) {
                    arToolkitContext.update(arToolkitSource.domElement);
                }
                renderer.render(scene, camera);
            }
            animate();
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;"></body>
</html>
