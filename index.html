<button id="startAR">ARを開始</button>
<button id="stopAR">ARを終了</button>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
    let xrSession = null; // WebXRセッションの管理

    async function initAR() {
        if (!navigator.xr) {
            alert("WebXR未対応のブラウザです。");
            return;
        }

        // ✅ すでにWebXRセッションがアクティブか確認
        if (xrSession) {
            console.warn("すでにWebXRセッションがアクティブです。");
            return;
        }

        try {
            xrSession = await navigator.xr.requestSession("immersive-ar", {
                requiredFeatures: ['hit-test']
            });

            console.log("WebXRセッション開始:", xrSession);

            // ✅ セッション終了時にリセット
            xrSession.addEventListener("end", () => {
                console.log("WebXRセッションが終了しました。");
                xrSession = null;
            });

        } catch (error) {
            console.error("WebXRセッションエラー:", error);
            xrSession = null;
        }
    }

    // ✅ 「ARを開始」ボタンを1回しか押せないようにする
    document.getElementById("startAR").addEventListener("click", () => {
        document.getElementById("startAR").disabled = true;
        initAR().finally(() => {
            document.getElementById("startAR").disabled = false;
        });
    });

    // ✅ WebXRセッションを明示的に終了するボタン
    document.getElementById("stopAR").addEventListener("click", () => {
        if (xrSession) {
            xrSession.end();
            console.log("WebXRセッションを手動で終了しました。");
        }
    });
</script>

