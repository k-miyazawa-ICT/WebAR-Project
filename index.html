<!DOCTYPE html>
<html>
<head>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- AR.js 3.4.7の複数候補URL -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js" onload="console.log('✅ AR.js 3.4.7 loaded successfully')" onerror="console.error('❌ Failed to load AR.js 3.4.7')"></script>
  <!-- 代替URL（必要に応じて） -->
  <script src="https://unpkg.com/ar.js@3.4.7/aframe/build/aframe-ar.js" onload="console.log('✅ AR.js 3.4.7 loaded from unpkg')" onerror="console.error('❌ Failed to load AR.js 3.4.7 from unpkg')"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true; trackingMethod: best; detectionMode: mono; sourceWidth: 640; sourceHeight: 480;">
    <a-marker type="barcode" value="0" id="marker">
      <a-entity id="model"
                position="0 0 -2"
                scale="2 2 2"
                visible="false"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const marker = document.querySelector("#marker");
    const model = document.querySelector("#model");
    let isMarkerDetected = false;
    let lastDetectionTime = 0;

    console.log("✅ シーンが初期化されました。カメラ起動中...");
    console.log("🔍 AR.jsバージョン: 3.4.7を読み込み中...");

    marker.addEventListener("markerFound", () => {
      const currentTime = Date.now();
      if (!isMarkerDetected || (currentTime - lastDetectionTime > 2000)) {
        if (!isMarkerDetected) {
          console.log("✅ ArUcoマーカー（ID: 0）を検出しました！");
          alert("ArUcoマーカーが認識されました！3Dモデルを読み込みます...");

          model.setAttribute("gltf-model", "https://k-miyazawa-ICT.github.io/WebAR-Project/model.glb");
          setTimeout(() => {
            model.setAttribute("visible", "true");
            console.log("✅ モデルを表示しました");
          }, 1000);

          isMarkerDetected = true;
          lastDetectionTime = currentTime;
        } else {
          console.log("✅ マーカー再検出：モデルはすでに表示中");
        }
      }
    });

    model.addEventListener("model-loaded", () => {
      console.log("✅ 3Dモデルが正常に読み込まれました！");
      if (isMarkerDetected && !model.getAttribute("visible")) {
        alert("3Dモデルが表示されました！");
      }
    });

    model.addEventListener("error", (err) => {
      console.error("❌ 3Dモデルの読み込みに失敗しました:", err);
      alert("3Dモデルの読み込みに失敗しました！GLBファイルのURLを確認してください。");
    });

    marker.addEventListener("markerLost", () => {
      console.log("❌ マーカーを見失いました！モデルは固定表示を維持します。");
    });

    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log("✅ a-sceneがロードされました。ARトラッキングを開始します。");
    });
  </script>
</body>
</html>
